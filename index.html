<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Insights Dashboard</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&family=IBM+Plex+Mono:wght@500&display=swap');

:root {
  --bg-base: #f2f4f6;
  --bg-card: #ffffff;
  --text-primary: #191f28;
  --text-secondary: #4e5968;
  --text-muted: #8b95a1;
  --toss-blue: #3182f6;
  --toss-red: #f04452;
  --toss-green: #00d082;
  --border: #eceef0;
  --sans: 'Pretendard', sans-serif;
  --mono: 'IBM Plex Mono', monospace;
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: var(--sans); background: var(--bg-base); color: var(--text-primary); padding: 20px; }
.container { max-width: 1000px; margin: 0 auto; }

.header { text-align: center; margin-bottom: 30px; }
.header-title { font-size: 14px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
.status-wrap { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; color: var(--text-muted); margin-top: 8px; }
.pulse { width: 6px; height: 6px; background: var(--toss-green); border-radius: 50%; }

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media(max-width:768px){ .grid { grid-template-columns:1fr; } }

.card { background: var(--bg-card); border-radius: 24px; padding: 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
.card-label { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
.card-label span { font-size: 14px; color: var(--text-secondary); font-weight: 500; display: block; margin-top: 2px; }

.value-row { display: flex; align-items: baseline; gap: 8px; margin: 12px 0; }
.card-value { font-size: 42px; font-weight: 700; color: var(--text-primary); }
.card-change { font-size: 14px; font-weight: 600; padding: 4px 10px; border-radius: 6px; }
.card-change.up { color: var(--toss-red); background: #fff0f1; }
.card-change.down { color: var(--toss-blue); background: #e8f3ff; }

.chart-container { width: 100%; height: 80px; margin: 15px 0; }
canvas { width: 100% !important; height: 100% !important; }

.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; padding-top: 20px; border-top: 1px solid var(--border); margin-top: 10px; }
.stat-item { display: flex; flex-direction: column; gap: 4px; }
.stat-lbl { font-size: 11px; color: var(--text-muted); }
.stat-val { font-size: 13px; color: var(--text-secondary); font-family: var(--mono); font-weight: 600; }

.source-tag { font-size: 10px; color: #ced4da; margin-top: 15px; }
.error-msg { position: absolute; bottom: 10px; color: var(--toss-red); font-size: 10px; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-title">Global Market Dashboard</div>
    <div class="status-wrap"><span class="pulse"></span><span id="lastUpdated">데이터를 불러오는 중...</span></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-label">공포지수 <span>VIX</span></div>
      <div class="value-row">
        <span class="card-value" id="vix-val">—</span>
        <span class="card-change" id="vix-chg"></span>
      </div>
      <div class="chart-container"><canvas id="vix-spark"></canvas></div>
      <div class="stats-grid">
        <div class="stat-item"><span class="stat-lbl">한달 평균</span><span class="stat-val" id="vix-avg">—</span></div>
        <div class="stat-item"><span class="stat-lbl">1년전</span><span class="stat-val">14.15</span></div>
        <div class="stat-item"><span class="stat-lbl">위험도</span><span class="stat-val" id="vix-zone">—</span></div>
      </div>
      <div class="source-tag">Source: Yahoo Finance</div>
    </div>

    <div class="card">
      <div class="card-label">S&P 500 P/E <span>주가수익비율</span></div>
      <div class="value-row">
        <span class="card-value" id="pe-val">—</span>
        <span class="card-change" id="pe-chg"></span>
      </div>
      <div class="chart-container"><canvas id="pe-spark"></canvas></div>
      <div class="stats-grid">
        <div class="stat-item"><span class="stat-lbl">전월 값</span><span class="stat-val" id="pe-prev-val">—</span></div>
        <div class="stat-item"><span class="stat-lbl">역사적 평균</span><span class="stat-val">16.05</span></div>
        <div class="stat-item"><span class="stat-lbl">평가</span><span class="stat-val" id="pe-eval">—</span></div>
      </div>
      <div id="pe-error" class="error-msg"></div>
      <div class="source-tag">Source: Multpl</div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

// 헬퍼: 차트 그리기
function drawSparkline(canvasId, data, color) {
  const canvas = $(canvasId);
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;
  canvas.width = w * dpr; canvas.height = h * dpr;
  ctx.scale(dpr, dpr);

  const min = Math.min(...data);
  const max = Math.max(...data);
  const range = max - min || 1;
  const padding = 10;
  const points = data.map((v, i) => ({
    x: (i / (data.length - 1)) * w,
    y: h - ((v - min) / range) * (h - padding * 2) - padding
  }));

  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  points.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.stroke();
}

// VIX 데이터
async function loadVIX() {
  try {
    const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/^VIX?range=1mo&interval=1d')}`);
    const data = JSON.parse((await res.json()).contents);
    const result = data.chart.result[0];
    const prices = result.indicators.quote[0].close.filter(x => x);
    const current = prices[prices.length - 1];
    const prev = prices[prices.length - 2];
    const diff = current - prev;

    $('vix-val').textContent = current.toFixed(2);
    $('vix-chg').textContent = (diff >= 0 ? '+' : '') + diff.toFixed(2);
    $('vix-chg').className = 'card-change ' + (diff >= 0 ? 'up' : 'down');
    $('vix-avg').textContent = (prices.reduce((a, b) => a + b) / prices.length).toFixed(1);
    $('vix-zone').textContent = current > 20 ? '높음' : '안정';
    drawSparkline('vix-spark', prices, diff >= 0 ? '#f04452' : '#3182f6');
  } catch (e) { console.error(e); }
}

// S&P 500 PE 데이터 (가장 확실한 문자열 파싱 방식)
async function loadPE() {
  try {
    // 프록시 서버를 통해 Multpl 페이지를 텍스트로 가져옴
    const targetUrl = 'https://www.multpl.com/s-p-500-pe-ratio/table/by-month';
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&t=${Date.now()}`;
    
    const response = await fetch(proxyUrl);
    const json = await response.json();
    const html = json.contents;

    if (!html) throw new Error("데이터를 가져오지 못했습니다.");

    // HTML 테이블 구조에서 수치 추출 (더 단순한 로직)
    const tableParts = html.split('class="right">');
    const peValues = [];

    for (let i = 1; i < tableParts.length; i++) {
      const val = parseFloat(tableParts[i].split('</td>')[0].trim());
      if (!isNaN(val)) peValues.push(val);
      if (peValues.length >= 12) break; // 최근 12개월치만
    }

    if (peValues.length === 0) throw new Error("데이터 파싱 실패");

    const current = peValues[0];
    const prev = peValues[1];
    const diff = current - prev;

    $('pe-val').textContent = current.toFixed(2);
    $('pe-chg').textContent = (diff >= 0 ? '+' : '') + diff.toFixed(2);
    $('pe-chg').className = 'card-change ' + (diff >= 0 ? 'up' : 'down');
    $('pe-prev-val').textContent = prev.toFixed(2);
    $('pe-eval').textContent = current > 25 ? '고평가' : (current < 15 ? '저평가' : '적정');
    
    drawSparkline('pe-spark', [...peValues].reverse(), diff >= 0 ? '#f04452' : '#3182f6');
    $('pe-error').textContent = ""; 
  } catch (e) {
    console.error("PE Error:", e);
    $('pe-error').textContent = "연결 오류 (잠시 후 다시 시도)";
  }
}

async function init() {
  await Promise.all([loadVIX(), loadPE()]);
  $('lastUpdated').textContent = "마지막 업데이트: " + new Date().toLocaleTimeString();
}

window.onload = init;
</script>
</body>
</html>
